import{_ as t}from"./plugin-vue_export-helper-x3n3nnut.js";import{r as p,o as e,c as o,a as c,b as n,d as s,e as l,f as d}from"./app-VKLC1A-x.js";const i={},u=n("p",null,"实现切片表转换为拉链表",-1),k=n("h1",{id:"切片表转换为拉链表",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#切片表转换为拉链表","aria-hidden":"true"},"#"),s(" 切片表转换为拉链表")],-1),r={href:"https://ask.csdn.net/questions/7729088",target:"_blank",rel:"noopener noreferrer"},v=d(`<h2 id="需求" tabindex="-1"><a class="header-anchor" href="#需求" aria-hidden="true">#</a> 需求</h2><p>现有全量切片表样数据如下：</p><table><thead><tr><th>切片日期</th><th>主键编号</th><th>状态</th></tr></thead><tbody><tr><td>20211201</td><td>A</td><td>01</td></tr><tr><td>20211205</td><td>A</td><td>01</td></tr><tr><td>20220215</td><td>A</td><td>02</td></tr><tr><td>20220228</td><td>A</td><td>03</td></tr><tr><td>20220315</td><td>A</td><td>01</td></tr><tr><td>20220331</td><td>A</td><td>01</td></tr><tr><td>20220420</td><td>A</td><td>01</td></tr><tr><td>20220425</td><td>A</td><td>02</td></tr><tr><td>20220430</td><td>A</td><td>01</td></tr><tr><td>20211201</td><td>B</td><td>01</td></tr><tr><td>20211203</td><td>B</td><td>01</td></tr><tr><td>20220131</td><td>B</td><td>02</td></tr></tbody></table><p>要求将其一次性转换成拉链数据，转换结果如下所示：</p><table><thead><tr><th>主键编号</th><th>开始日期</th><th>状态</th><th>结束日期</th></tr></thead><tbody><tr><td>A</td><td>20211201</td><td>01</td><td>20220215</td></tr><tr><td>A</td><td>20220215</td><td>02</td><td>20220228</td></tr><tr><td>A</td><td>20220228</td><td>03</td><td>20220315</td></tr><tr><td>A</td><td>20220315</td><td>01</td><td>20220425</td></tr><tr><td>A</td><td>20220425</td><td>02</td><td>20220430</td></tr><tr><td>A</td><td>20220430</td><td>01</td><td>99991231</td></tr><tr><td>B</td><td>20211201</td><td>01</td><td>20220131</td></tr><tr><td>B</td><td>20220131</td><td>02</td><td>99991231</td></tr></tbody></table><h2 id="数据准备" tabindex="-1"><a class="header-anchor" href="#数据准备" aria-hidden="true">#</a> 数据准备</h2><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> slip_table
<span class="token punctuation">(</span>
  <span class="token keyword">date</span>    <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  id      <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">status</span>  <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> slip_table <span class="token keyword">VALUES</span>
<span class="token punctuation">(</span><span class="token string">&#39;20211201&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;A&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;01&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">&#39;20211205&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;A&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;01&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">&#39;20220215&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;A&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;02&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">&#39;20220228&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;A&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;03&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">&#39;20220315&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;A&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;01&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">&#39;20220331&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;A&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;01&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">&#39;20220420&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;A&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;01&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">&#39;20220425&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;A&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;02&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">&#39;20220430&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;A&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;01&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">&#39;20211201&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;B&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;01&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">&#39;20211203&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;B&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;01&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">&#39;20220131&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;B&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;02&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="解决方案" tabindex="-1"><a class="header-anchor" href="#解决方案" aria-hidden="true">#</a> 解决方案</h2><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> t3<span class="token punctuation">.</span>id
      <span class="token punctuation">,</span>t3<span class="token punctuation">.</span><span class="token keyword">date</span>   <span class="token keyword">AS</span> start_date
      <span class="token punctuation">,</span>t3<span class="token punctuation">.</span><span class="token keyword">status</span>
      <span class="token punctuation">,</span>LEAD<span class="token punctuation">(</span>t3<span class="token punctuation">.</span><span class="token keyword">date</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&#39;99991231&#39;</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> t3<span class="token punctuation">.</span>id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> t3<span class="token punctuation">.</span><span class="token keyword">date</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> end_date
<span class="token keyword">FROM</span><span class="token punctuation">(</span>
     <span class="token keyword">SELECT</span> t2<span class="token punctuation">.</span><span class="token keyword">date</span>
           <span class="token punctuation">,</span>t2<span class="token punctuation">.</span>id
           <span class="token punctuation">,</span>t2<span class="token punctuation">.</span><span class="token keyword">status</span>
           <span class="token punctuation">,</span>ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> t2<span class="token punctuation">.</span>id<span class="token punctuation">,</span> t2<span class="token punctuation">.</span><span class="token keyword">status</span><span class="token punctuation">,</span> t2<span class="token punctuation">.</span>group1 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> t2<span class="token punctuation">.</span><span class="token keyword">date</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> rank3
     <span class="token keyword">FROM</span><span class="token punctuation">(</span>
          <span class="token keyword">SELECT</span> t1<span class="token punctuation">.</span><span class="token keyword">date</span>
                <span class="token punctuation">,</span>t1<span class="token punctuation">.</span>id
                <span class="token punctuation">,</span>t1<span class="token punctuation">.</span><span class="token keyword">status</span>
                <span class="token punctuation">,</span>FLOOR<span class="token punctuation">(</span>t1<span class="token punctuation">.</span>rank1 <span class="token operator">-</span> t1<span class="token punctuation">.</span>rank2<span class="token punctuation">)</span> <span class="token keyword">AS</span> group1
          <span class="token keyword">FROM</span><span class="token punctuation">(</span>
               <span class="token keyword">SELECT</span> <span class="token keyword">date</span>
                     <span class="token punctuation">,</span>id
                     <span class="token punctuation">,</span><span class="token keyword">status</span>
                     <span class="token punctuation">,</span>ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">date</span><span class="token punctuation">)</span>         <span class="token keyword">AS</span> rank1
                     <span class="token punctuation">,</span>ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> id<span class="token punctuation">,</span> <span class="token keyword">status</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">date</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> rank2
               <span class="token keyword">FROM</span> slip_table
          <span class="token punctuation">)</span> t1
     <span class="token punctuation">)</span> t2
<span class="token punctuation">)</span> t3
<span class="token keyword">WHERE</span> t3<span class="token punctuation">.</span>rank3 <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,9);function b(m,y){const a=p("ExternalLinkIcon");return e(),o("div",null,[u,c(" more "),k,n("p",null,[s("参考资料："),n("a",r,[s("如何用SQL实现全量切片表转成拉链表"),l(a)])]),v])}const g=t(i,[["render",b],["__file","切片表转换为拉链表.html.vue"]]);export{g as default};
